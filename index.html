<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Last.fm Виджет (tobitohikimori)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            /* Фон для контраста на странице, сам виджет будет внутри своего блока */
            background-color: #262626;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
/* Добавить это */
    margin: 0;
    padding: 0;
        }

        /* Основной контейнер виджета - растягивается, но сохраняет квадратную форму */
        .widget-container {
            width: 100%;

            background-color: #262626;
	    padding: 24px 0;
            display: flex;
            flex-direction: column;
            color: #D4D4D4;

            transition: all 0.2s ease;
/* Добавить ЭТИ три строки */
    overflow: hidden; /* Обрезает всё, что выходит за пределы */
    box-sizing: border-box; /* Учитывает padding в общей высоте */
    height: 100%; /* Явно указываем высоту */
        }

        /* Блок с обложкой */
        .cover-section {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px; /* Отступ от картинки до блока с названиями (меньше, чем следующий) */
        }

        .cover-image {
            width: 120px;
            height: 120px;
            border-radius: 8px; /* Немного скруглим обложку */
            background-color: #3a3a3a; /* Цвет фона, пока грузится */
            display: flex;
            justify-content: center;
            align-items: center;
            object-fit: cover; /* Чтобы картинка заполняла пространство */
        }

        /* Векторный виниловый диск (запасной вариант) */
        .vinyl-record {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #555, #111);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .vinyl-record::before {
            content: "";
            width: 70px;
            height: 70px;
            background: radial-gradient(circle, #ccc, #666);
            border-radius: 50%;
            position: absolute;
            top: 45px;
            left: 45px;
            box-shadow: 0 0 10px rgba(0,0,0,0.7);
        }

        .vinyl-record::after {
            content: "";
            width: 25px;
            height: 25px;
            background-color: #ffd966;
            border-radius: 50%;
            position: absolute;
            top: 67.5px;
            left: 67.5px;
            box-shadow: 0 0 8px gold;
        }

        /* Блок с текстовой информацией */
        .info-section {
            display: flex;
            flex-direction: column;
        }

        .track-name {
            font-size: 20px;
            font-weight: 600;
            color: #D4D4D4;
            line-height: 150%; /* 30px */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            text-align: center;
        }

        .artist-name {
            font-size: 16px;
            color: #7C7C7C;
            line-height: 160%; /* 25.6px */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            text-align: center;
            margin-bottom: 0px; /* Небольшой отступ перед статусом */
        }

        .status-section {
            display: flex;
            align-items: center;
            justify-content: center;
	    margin-bottom: 0px;
            gap: 4px; /* Расстояние между иконкой и текстом статуса */
            font-size: 16px;
            color: #7C7C7C;
            line-height: 160%;
            padding-top: 0px; /* Отступ от названия до статуса (больше, чем от картинки до названия) */
        }

        .status-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
        }

        /* Треугольник (Play) для онлайн */
        .icon-online {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
}

.icon-online svg {
    width: 16px;
    height: 16px;
    filter: drop-shadow(0 0 1px rgba(0,0,0,0.1));
}

        /* Квадратик для оффлайн */
        .icon-offline {
            width: 12px;
            height: 12px;
            background-color: #6B6B6B;
border-radius: 3px;
        }

        .status-text {
            white-space: nowrap;
        }

        /* Для ошибок или загрузки */
        .error-text {
            color: #ff6b6b;
            text-align: center;
            margin-top: 10px;
        }

    </style>
</head>
<body>
    <div id="app" class="widget-container">
        <!-- Блок с обложкой -->
        <div class="cover-section">
            <img 
                v-if="coverUrl" 
                :src="coverUrl" 
                alt="Обложка альбома" 
                class="cover-image"
                @error="handleImageError"
            >
            <div v-else class="cover-image vinyl-record"></div>
        </div>

        <!-- Блок с информацией о треке -->
        <div class="info-section">
            <div class="track-name" :title="trackName">{{ trackName }}</div>
            <div class="artist-name" :title="artistName">{{ artistName }}</div>
            
            <!-- Статус с иконкой -->
            <div class="status-section">
                <span class="status-icon">
                    <span v-if="isOnline" class="icon-online">
    <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 2L10 7L4 12V2Z" fill="#1DB954" stroke="#1DB954" stroke-width="0.5" rx="1"/>
    </svg>
</span>
                    <span v-else class="icon-offline"></span>
                </span>
                <span class="status-text">{{ statusText }}</span>
            </div>
        </div>
    </div>

    <!-- Подключаем Vue.js и Axios для удобства -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        const { createApp, ref, onMounted } = Vue;

        const app = createApp({
            setup() {
                // Данные виджета
                const coverUrl = ref('');
                const trackName = ref('Загрузка...');
                const artistName = ref('Загрузка...');
                const statusText = ref('Ожидание');
                const isOnline = ref(false);
                
                // Для хранения последнего успешного трека
                let lastValidTrack = {
                    cover: '',
                    track: '—',
                    artist: '—'
                };

                // API данные
                const username = 'tobitohikimori';
                const apiKey = '90fe6e5b8710ef0a8818bb5bf6609918';
                const baseUrl = 'https://ws.audioscrobbler.com/2.0/';

                // Функция для форматирования времени
                function formatTimeAgo(timestamp) {
                    const now = Math.floor(Date.now() / 1000);
                    const diff = now - timestamp;

                    if (diff < 0) return 'только что'; // На случай рассинхронизации времени

                    const minutes = Math.floor(diff / 60);
                    const hours = Math.floor(diff / 3600);
                    const days = Math.floor(diff / 86400);
                    const months = Math.floor(diff / (86400 * 30));
                    const years = Math.floor(diff / (86400 * 365));

                    if (minutes < 1) return 'только что';
                    if (minutes < 60) return `${minutes} мин назад`;
                    if (hours < 24) return `${hours} ч назад`;
                    if (days < 30) return `${days} дн назад`;
                    if (months < 12) return `${months} мес назад`;
                    return `${years} г назад`;
                }

                // Функция для обработки ошибки загрузки изображения
                const handleImageError = (e) => {
                    console.log('Ошибка загрузки изображения, показываем винил');
                    coverUrl.value = ''; // Убираем URL, показываем винил
                };

                // Основная функция получения данных
                async function fetchNowPlaying() {
                    try {
                        const response = await axios.get(baseUrl, {
                            params: {
                                method: 'user.getrecenttracks',
                                user: username,
                                api_key: apiKey,
                                format: 'json',
                                limit: 1,
                                extended: 1 // Чтобы получить больше данных, включая изображения
                            }
                        });

                        const tracks = response.data?.recenttracks?.track;
                        if (!tracks || tracks.length === 0) {
                            // Нет треков вообще
                            trackName.value = 'Нет истории';
                            artistName.value = '—';
                            statusText.value = 'нет данных';
                            isOnline.value = false;
                            coverUrl.value = ''; // Покажем винил
                            return;
                        }

                        const currentTrack = tracks[0];
                        
                        // Проверяем, играет ли сейчас
                        const nowPlayingAttr = currentTrack['@attr']?.nowplaying;
                        isOnline.value = nowPlayingAttr === 'true';

                        // Получаем название трека
                        const newTrackName = currentTrack.name?.trim() || 'Без названия';
                        
                        // Получаем имя исполнителя
                        const newArtistName = currentTrack.artist?.name?.trim() || 'Неизвестно';
                        
                        // Получаем обложку (берем большое изображение, если есть)
                        let newCoverUrl = '';
                        if (currentTrack.image && currentTrack.image.length > 0) {
                            // Ищем изображение размером large или extralarge
                            const largeImage = currentTrack.image.find(img => img.size === 'extralarge') || 
                                             currentTrack.image.find(img => img.size === 'large') ||
                                             currentTrack.image[currentTrack.image.length - 1]; // Самое большое из доступных
                            
                            if (largeImage && largeImage['#text']) {
                                newCoverUrl = largeImage['#text'];
                            }
                        }

                        // Обновляем последний валидный трек, если получили данные
                        // (даже если сейчас не играет, это все равно последнее прослушанное)
                        if (newTrackName && newArtistName) {
                            lastValidTrack = {
                                cover: newCoverUrl,
                                track: newTrackName,
                                artist: newArtistName
                            };
                        }

                        // Применяем новые данные
                        trackName.value = newTrackName;
                        artistName.value = newArtistName;
                        
                        // Если есть обложка и она не пустая, используем её, иначе винил
                        if (newCoverUrl && newCoverUrl.trim() !== '') {
                            coverUrl.value = newCoverUrl;
                        } else {
                            coverUrl.value = ''; // Покажем винил
                        }

                        // Формируем статус
                        if (isOnline.value) {
                            statusText.value = 'Онлайн';
                        } else {
                            // Если не онлайн, берем время из даты
                            const dateAttr = currentTrack.date;
                            if (dateAttr && dateAttr.uts) {
                                statusText.value = formatTimeAgo(parseInt(dateAttr.uts));
                            } else {
                                statusText.value = 'Недавно';
                            }
                        }

                    } catch (error) {
                        console.error('Ошибка при запросе к Last.fm:', error);
                        
                        // В случае ошибки показываем последний успешно загруженный трек
                        if (lastValidTrack.track !== '—') {
                            trackName.value = lastValidTrack.track;
                            artistName.value = lastValidTrack.artist;
                            coverUrl.value = lastValidTrack.cover; // Если пусто, покажет винил
                        } else {
                            trackName.value = 'Ошибка загрузки';
                            artistName.value = 'Проверьте соединение';
                            coverUrl.value = '';
                        }
                        
                        statusText.value = 'ошибка';
                        isOnline.value = false;
                    }
                }

                // Запускаем сразу и устанавливаем интервал
                onMounted(() => {
                    fetchNowPlaying();
                    setInterval(fetchNowPlaying, 5000); // Каждые 5 секунд
                });

                return {
                    coverUrl,
                    trackName,
                    artistName,
                    statusText,
                    isOnline,
                    handleImageError
                };
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
